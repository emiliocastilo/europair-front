<ng-container *ngIf="routeData$ | async as routeData">
  <core-page-bar [pageTitle]="routeData.title | translate"></core-page-bar>
  <div class="button-row" appHeaderSticky>
    <div class="cmd-mb-2">
      <button class="browser-default cmd-mr-2" color="primary" mat-raised-button
        (click)="returnToFileList()">
        {{ "COMMON.RETURN" | translate }}
      </button>

      <button class="browser-default" color="primary" mat-raised-button [disabled]="!fileForm.valid"
        *ngIf="showAction(fileAction.MODIFY_FILE)" (click)="onSaveFile(routeData.isFileDetail)">
        {{ "FILES.SAVE_FILE" | translate }}
      </button>
    </div>

    <div class="cmd-mb-2">
      <button *ngIf="showAction(fileAction.CONFIRM_OPERATION)" color="primary" 
        (click)="navigateConfirmOperation()" mat-raised-button>
        {{ "FILES.CONFIRM_OPERATION" | translate }}
      </button>

      <button *ngIf="showAction(fileAction.CREATE_CONTRACT)" color="primary" 
        (click)="createContract()" mat-raised-button>
        {{ "FILES.CREATE_CONTRACT" | translate }}
      </button>

      <button *ngIf="showAction(fileAction.SIGN_FILE)" color="primary" 
        (click)="signFile()" mat-raised-button>
        {{ "FILES.SING_FILE" | translate }}
      </button>

      <button *ngIf="showAction(fileAction.GENERATE_PLANING)" color="primary"
        (click)="generatePlanning()" mat-raised-button class="cmd-mx-2">
        {{ "FILES.GENERATE_PLANING" | translate }}
      </button>
    </div>
  </div>

  <mat-accordion multi>
    <mat-expansion-panel class="app-expansion-panel" expanded="true">
      <mat-expansion-panel-header class="cmd-mb-2">
        <mat-panel-title>
          {{ "COMMON.GENERAL_DATA" | translate | sentenceCase }}
        </mat-panel-title>
      </mat-expansion-panel-header>
      <ng-template matExpansionPanelContent>
        <form [formGroup]="fileForm">
          <div class="row">
            <app-input [prefix]="'FILES.CODE' | translate" [hasErrors]="hasControlAnyError('code')"
              [errorStateMatcher]="matcher" formControlName="code" class="col s12 l4">
            </app-input>

            <app-input [prefix]="'FILES.DESCRIPTION' | translate" [hasErrors]="hasControlAnyError('description')"
              [errorStateMatcher]="matcher" formControlName="description" class="col s12 l4">
              <ng-container inputErrors>
                <mat-error class="ep-error-msg" *ngIf="hasControlAnyError('description')">
                  {{ "FILES.ERRORS.DESCRIPTION" | translate }}
                </mat-error>
              </ng-container>
            </app-input>


            <app-select class="col s12 l4" [id]="'select-file-status'" [items]="statusOptions" *ngIf="routeData.isFileDetail"
              [placeholder]="'FILES.STATUS' | translate" [ngClass]="{'booked-blue': isBookedBlue(), 'booked-green': isBookedGreen()}" [clearable]="false"
              [label]="'FILES.STATUS' | translate" [itemDescription]="'name'" [itemValue]="'id'" formControlName="statusId" (selectedValueEvent)="updateFileState($event)">
              <ng-container inputErrors *ngIf="hasControlAnyError('statusId')">
                <span *ngIf="hasControlSpecificError('statusId', 'required')" class="helper-text"
                  [attr.data-error]="'FILES.ERRORS.REQUIRED' | translate">
                </span>
              </ng-container>
            </app-select>
          </div>

          <div class="row">
            <app-autocomplete class="col s12 l4" [options]="contactOptions$ | async"
              [prefix]="'FILES.CONTACT' | translate" [lengthToTriggerSearch]="0" optionValue="id" optionLabel="name"
              formControlName="contact">
            </app-autocomplete>

            <app-autocomplete class="col s12 l4" [options]="clientOptions$ | async"
              [prefix]="'FILES.CLIENT' | translate" [lengthToTriggerSearch]="0" optionValue="id" optionLabel="name"
              formControlName="client">
            </app-autocomplete>
          </div>
          <div class="row">
            <app-select class="col s12 l4" [id]="'select-file-operation-type'" [items]="operationsType" [dropdownPosition]="'top'"
              [placeholder]="'FILES.OPERATION_TYPE' | translate" [clearable]="false"
              [label]="'FILES.OPERATION_TYPE' | translate" formControlName="operationType">
              <ng-container inputErrors *ngIf="hasControlAnyError('operationType')">
                <span *ngIf="hasControlSpecificError('operationType', 'required')" class="helper-text"
                  [attr.data-error]="'FILES.ERRORS.REQUIRED' | translate">
                </span>
              </ng-container>
            </app-select>
          </div>
        </form>
      </ng-template>
    </mat-expansion-panel>

    <ng-container *ngIf="routeData.isFileDetail">
      <mat-expansion-panel #routes class="app-expansion-panel cmd-mb-2" expanded="true">
        <mat-expansion-panel-header>
          <mat-panel-title>
            {{ "FILES.ROUTES.TITLE" | translate | sentenceCase }}
          </mat-panel-title>
          <mat-panel-description *ngIf="routes.expanded && showAction(fileAction.CREATE_ROUTES)">
            <a mat-button routerLink="routes/new">
              {{ "FILES.NEW_ROUTE" | translate | sentenceCase }}
              <mat-icon svgIcon="europair_add"></mat-icon>
            </a>
          </mat-panel-description>
        </mat-expansion-panel-header>

        <!-- <ng-template matExpansionPanelContent> -->
        <div class="table-container">
          <mat-table #routesTable matSort multiTemplateDataRows [dataSource]="dataSource">
            <!-- Label Column -->
            <ng-container matColumnDef="label" sticky>
              <mat-header-cell *matHeaderCellDef mat-sort-header>
                {{ "FILES.ROUTES.PETITION_ROUTES" | translate }}
              </mat-header-cell>
              <mat-cell *matCellDef="let element" class="parent-route">
                <mat-icon class="expand-icon" *ngIf="element?.hasContributions"
                  [class.active]="expandedRoutes.includes(element)">
                  expand_more
                </mat-icon>
                {{ element.label }}
              </mat-cell>
            </ng-container>

            <!-- Frequency Column -->
            <ng-container matColumnDef="frequency">
              <mat-header-cell *matHeaderCellDef mat-sort-header>
                {{ "FILES.ROUTES.FREQUENCY" | translate }}
              </mat-header-cell>
              <mat-cell *matCellDef="let element">
                {{ element.frequency }}
              </mat-cell>
            </ng-container>

            <!-- startDate Column-->
            <ng-container matColumnDef="startDate">
              <mat-header-cell *matHeaderCellDef mat-sort-header>
                {{ "FILES.ROUTES.START_DATE" | translate }}
              </mat-header-cell>
              <mat-cell *matCellDef="let element">
                {{ element.startDate | date: 'dd/MM/yyyy' }}
              </mat-cell>
            </ng-container>

            <!-- EndDate Column-->
            <ng-container matColumnDef="endDate">
              <mat-header-cell *matHeaderCellDef mat-sort-header>
                {{ "FILES.ROUTES.END_DATE" | translate }}
              </mat-header-cell>
              <mat-cell *matCellDef="let element">
                {{ element.endDate | date: 'dd/MM/yyyy' }}
              </mat-cell>
            </ng-container>

            <!-- WeekDays Column-->
            <ng-container matColumnDef="frequencyDays">
              <mat-header-cell *matHeaderCellDef mat-sort-header>
                {{ "FILES.ROUTES.WEEKDAYS" | translate }}
              </mat-header-cell>
              <mat-cell *matCellDef="let element">
                {{ getFormattedFrequency(element.frequencyDays) | uppercase }}
              </mat-cell>
            </ng-container>

            <!-- Rotations Column-->
            <ng-container matColumnDef="rotations.length">
              <mat-header-cell *matHeaderCellDef mat-sort-header>
                {{ "FILES.ROUTES.ROTATIONS_NUMBER" | translate }}
              </mat-header-cell>
              <mat-cell *matCellDef="let element">
                {{ element.rotations.length }}
              </mat-cell>
            </ng-container>

            <!-- Seats Column-->
            <ng-container matColumnDef="seats">
              <mat-header-cell *matHeaderCellDef mat-sort-header>
                {{ "FILES.ROUTES.SEATS_F_C_Y" | translate }}
              </mat-header-cell>
              <mat-cell *matCellDef="let element">
                {{ element.seatsF || 0 }}/{{ element.seatsC || 0 }}/{{ element.seatsY || 0 }}
              </mat-cell>
            </ng-container>

            <!-- Month Day Column-->
            <ng-container matColumnDef="dayNumber">
              <mat-header-cell *matHeaderCellDef mat-sort-header>
                {{ "FILES.ROUTES.MONTH_DAY" | translate }}
              </mat-header-cell>
              <mat-cell *matCellDef="let element">
                {{ getFormattedMonthDays(element.frequencyDays) }}
              </mat-cell>
            </ng-container>

            <!-- Status Column-->
            <ng-container matColumnDef="status" stickyEnd>
              <mat-header-cell *matHeaderCellDef mat-sort-header>
                {{ "FILES.ROUTES.STATUS" | translate }}
              </mat-header-cell>
              <mat-cell *matCellDef="let element"> {{ element.routeState }} </mat-cell>
            </ng-container>

            <!-- Actions Column-->
            <ng-container matColumnDef="route-actions" stickyEnd>
              <mat-header-cell *matHeaderCellDef></mat-header-cell>
              <mat-cell *matCellDef="let element" (click)="$event.stopPropagation()">
                <mat-icon
                  (click)="navigateToCopyRoute(element.id)"
                  svgIcon="europair_add_trace"
                  [matTooltip]="'TOOLTIPS.COPY_ROUTE'| translate" [matTooltipClass]="'europair-tooltip'"
                ></mat-icon>
                <mat-icon
                  (click)="navigateToSearchAircraft(element.id)"
                  svgIcon="europair_plane"
                  [matTooltip]="'TOOLTIPS.SEARCH_AIRCRAFT'| translate" [matTooltipClass]="'europair-tooltip'"
                ></mat-icon>
                <mat-icon *ngIf="element.routeState === ROUTE_STATUS.WON"
                  (click)="generateContract(element.id)"
                  svgIcon="europair_document"
                  [matTooltip]="'TOOLTIPS.GENERATE_CONTRACT'| translate" [matTooltipClass]="'europair-tooltip'"
                ></mat-icon>
                <mat-icon
                  (click)="deleteRoute(element.id, 'FILES.ROUTE_DELETE_MSG')"
                  svgIcon="europair_trash"
                  [matTooltip]="'TOOLTIPS.REMOVE_ROUTE'| translate" [matTooltipClass]="'europair-tooltip'"
                ></mat-icon>
              </mat-cell>
            </ng-container>

            <!-- Expanded Content Column - The detail row is made up of this one column that spans across all columns -->
            <ng-container matColumnDef="expandedDetail">
              <mat-cell *matCellDef="let parentElement">
                <mat-table [dataSource]="getChildRoutes(parentElement)">
                  <!-- Label Column -->
                  <ng-container matColumnDef="label">
                    <mat-cell *matCellDef="let element" [ngClass]="{'expanded-table-sticky start': !isSmallScreen()}">
                      <span class="separator"> </span>
                      {{ element.label }}
                    </mat-cell>
                  </ng-container>

                  <!-- Frequency Column -->
                  <ng-container matColumnDef="frequency">
                    <mat-cell *matCellDef="let element">
                      {{ element.frequency }}
                    </mat-cell>
                  </ng-container>

                  <!-- startDate Column-->
                  <ng-container matColumnDef="startDate">
                    <mat-cell *matCellDef="let element">
                      {{ element.startDate }}
                    </mat-cell>
                  </ng-container>

                  <!-- EndDate Column-->
                  <ng-container matColumnDef="endDate">
                    <mat-cell *matCellDef="let element">
                      {{ element.endDate }}
                    </mat-cell>
                  </ng-container>

                  <!-- WeekDays Column-->
                  <ng-container matColumnDef="frequencyDays">
                    <mat-cell *matCellDef="let element">
                      {{
                        getRotationFormattedFrequency(element.startDate) | uppercase
                      }}
                    </mat-cell>
                  </ng-container>

                  <!-- Rotations Column-->
                  <ng-container matColumnDef="rotations.length">
                    <mat-cell *matCellDef="let element">
                      {{ getRotationNumber(parentElement, element) }}
                    </mat-cell>
                  </ng-container>

                  <!-- Seats Column-->
                  <ng-container matColumnDef="seats">
                    <mat-cell *matCellDef="let element">
                      {{ element.seatsF || 0 }}/{{ element.seatsC || 0 }}/{{ element.seatsY || 0 }}
                    </mat-cell>
                  </ng-container>

                  <!-- Month Day Column-->
                  <ng-container matColumnDef="dayNumber">
                    <mat-cell *matCellDef="let element" [ngClass]="{'expanded-last-row': !isSmallScreen()}">
                      {{ element.startDate | date:'dd' }}
                    </mat-cell>
                    <mat-cell> - </mat-cell>
                  </ng-container>

                  <!-- Status Column-->
                  <ng-container matColumnDef="status">
                    <mat-cell *matCellDef="let element" [ngClass]="{'expanded-table-sticky end': !isSmallScreen()}">
                      {{ element.routeState }}
                    </mat-cell>
                  </ng-container>

                  <!-- Actions Column-->
                  <ng-container matColumnDef="route-actions">
                    <mat-cell
                      *matCellDef="let element"
                      [ngClass]="{'expanded-table-sticky end': !isSmallScreen()}"
                    >
                      <mat-icon
                        (click)="editRotation(parentElement, element)"
                        svgIcon="europair_edit"
                        [matTooltip]="'TOOLTIPS.EDIT_ROTATION'| translate" [matTooltipClass]="'europair-tooltip'"
                      ></mat-icon>
                      <mat-icon                       
                        (click)="deleteRoute(element.id, 'FILES.ROTATION_DELETE_MSG')"
                        svgIcon="europair_trash"
                        [matTooltip]="'TOOLTIPS.REMOVE_ROTATION'| translate" [matTooltipClass]="'europair-tooltip'"
                      ></mat-icon>
                    </mat-cell>
                  </ng-container>

                  <mat-row *matRowDef="let element; columns: columnsToDisplay"></mat-row>
                </mat-table>
              </mat-cell>
            </ng-container>

            <mat-header-row *matHeaderRowDef="columnsToDisplay; sticky: true"></mat-header-row>
            <mat-row *matRowDef="let element; columns: columnsToDisplay" class="element-row"
              [class.expanded-row]="expandedRoutes.includes(element)" (click)="expandRow(element)"></mat-row>
            <mat-row class="detail-row" *matRowDef="let element; columns: ['expandedDetail']" [@detailExpand]="
              expandedRoutes.includes(element) ? 'expanded' : 'collapsed'
              " style="overflow: hidden"></mat-row>
          </mat-table>
        </div>

        <mat-paginator [length]="resultsLength" [pageSize]="pageSize"></mat-paginator>
      </mat-expansion-panel>

      <mat-expansion-panel class="app-expansion-panel cmd-mb-2" [expanded]="expandedQuote">
        <mat-expansion-panel-header>
          <mat-panel-title>
            {{ "Cotizaciones" | translate | sentenceCase }}
          </mat-panel-title>
        </mat-expansion-panel-header>
        <div class="table-container">
          <mat-table #contributionsTable matSort multiTemplateDataRows [dataSource]="dataSourceRouteContributions">
            <!-- Label Column -->
            <ng-container matColumnDef="label" sticky>
              <mat-header-cell *matHeaderCellDef mat-sort-header>
                {{ "FILES.CONTRIBUTIONS.ROUTES" | translate }}
              </mat-header-cell>
              <mat-cell *matCellDef="let element" class="parent-route">
                <mat-icon class="expand-icon" *ngIf="element.rotations.length > 0"
                  [class.active]="expandedContributions.includes(element)">
                  expand_more
                </mat-icon>
                {{ element.label }}
              </mat-cell>
            </ng-container>

            <!-- requestTime Column -->
            <ng-container matColumnDef="requestTime">
              <mat-header-cell *matHeaderCellDef mat-sort-header>
                {{ "FILES.CONTRIBUTIONS.REQUEST_TIME" | translate }}
              </mat-header-cell>
              <mat-cell *matCellDef="let element">
              </mat-cell>
            </ng-container>

            <!-- Operator Column-->
            <ng-container matColumnDef="operator">
              <mat-header-cell *matHeaderCellDef mat-sort-header>
                {{ "FILES.CONTRIBUTIONS.OPERATOR" | translate }}
              </mat-header-cell>
              <mat-cell *matCellDef="let element">
              </mat-cell>
            </ng-container>

            <!-- Aircraft type-->
            <ng-container matColumnDef="aircraftType">
              <mat-header-cell *matHeaderCellDef mat-sort-header>
                {{ "FILES.CONTRIBUTIONS.AIRCRAFT_TYPE" | translate }}
              </mat-header-cell>
              <mat-cell *matCellDef="let element">
              </mat-cell>
            </ng-container>

            <!-- Total passengers Column-->
            <ng-container matColumnDef="totalPassengers">
              <mat-header-cell *matHeaderCellDef mat-sort-header>
                {{ "FILES.CONTRIBUTIONS.TOTAL_PASSENGERS" | translate }}
              </mat-header-cell>
              <mat-cell *matCellDef="let element">
              </mat-cell>
            </ng-container>

            <!-- Purchase price Column-->
            <ng-container matColumnDef="purchasePrice">
              <mat-header-cell *matHeaderCellDef mat-sort-header>
                {{ "FILES.CONTRIBUTIONS.PURCHASE_PRICE" | translate }}
              </mat-header-cell>
              <mat-cell *matCellDef="let element">
              </mat-cell>
            </ng-container>

            <!-- purchaseCommissionPercent price Column-->
            <ng-container matColumnDef="purchaseCommissionPercent">
              <mat-header-cell *matHeaderCellDef mat-sort-header>
                {{ "FILES.CONTRIBUTIONS.PURCHASE_TAXES" | translate }}
              </mat-header-cell>
              <mat-cell *matCellDef="let element">
              </mat-cell>
            </ng-container>

            <!-- Sale price Column-->
            <ng-container matColumnDef="salesPrice">
              <mat-header-cell *matHeaderCellDef mat-sort-header>
                {{ "FILES.CONTRIBUTIONS.SALES_PRICE" | translate }}
              </mat-header-cell>
              <mat-cell *matCellDef="let element">
              </mat-cell>
            </ng-container>

            <!-- salesCommissionPercent price Column-->
            <ng-container matColumnDef="salesCommissionPercent">
              <mat-header-cell *matHeaderCellDef mat-sort-header>
                {{ "FILES.CONTRIBUTIONS.SALES_TAXES" | translate }}
              </mat-header-cell>
              <mat-cell *matCellDef="let element">
              </mat-cell>
            </ng-container>

            <!-- Status Column-->
            <ng-container matColumnDef="status" stickyEnd>
              <mat-header-cell *matHeaderCellDef mat-sort-header>
                {{ "FILES.CONTRIBUTIONS.STATUS" | translate }}
              </mat-header-cell>
              <mat-cell *matCellDef="let element"> {{ element.routeState }} </mat-cell>
            </ng-container>

            <!-- Actions Column-->
            <ng-container matColumnDef="contribution-actions" stickyEnd>
              <mat-header-cell *matHeaderCellDef>
                {{ "FILES.CONTRIBUTIONS.ACTIONS" | translate }}
              </mat-header-cell>
              <mat-cell *matCellDef="let element">
              </mat-cell>
            </ng-container>

            <!-- Expanded Content Column - The detail row is made up of this one column that spans across all columns -->
            <ng-container matColumnDef="expandedDetail">
              <mat-cell *matCellDef="let parentElement">
                <mat-table [dataSource]="getContributionData(parentElement)">
                  <!-- Label Column -->
                  <ng-container matColumnDef="label">
                    <mat-cell *matCellDef="let element" [ngClass]="{'expanded-table-sticky start': !isSmallScreen()}">
                      <span class="separator"> </span>
                    </mat-cell>
                  </ng-container>

                  <!-- requestTime Column -->
                  <ng-container matColumnDef="requestTime">
                    <mat-cell *matCellDef="let element">
                      {{ element?.requestTime | date: 'dd/MM/yyyy' }}
                    </mat-cell>
                  </ng-container>

                  <!-- operator Column-->
                  <ng-container matColumnDef="operator">
                    <mat-cell *matCellDef="let element">
                      <ng-container *ngIf="element?.operator?.name?.length > 25; else operatorText">
                        <div class="operator-container" [matTooltip]="element?.operator?.name" [matTooltipClass]="'europair-tooltip'">
                          {{ element?.operator?.name }}
                        </div>
                      </ng-container>
                      <ng-template #operatorText>
                        <div class="operator-container">
                          {{ element?.operator?.name }}
                        </div>
                      </ng-template>
                    </mat-cell>
                  </ng-container>

                  <!-- aircraftType Column-->
                  <ng-container matColumnDef="aircraftType">
                    <mat-cell *matCellDef="let element">
                      {{ element?.aircraft?.aircraftType?.code }}
                    </mat-cell>
                  </ng-container>

                  <!-- totalPassengers Column-->
                  <ng-container matColumnDef="totalPassengers">
                    <mat-cell *matCellDef="let element">
                      {{
                        getTotalPassengers(element)
                      }}
                    </mat-cell>
                  </ng-container>

                  <!-- purchasePrice Column-->
                  <ng-container matColumnDef="purchasePrice">
                    <mat-cell *matCellDef="let element">
                      {{ element?.purchasePrice | number }}
                    </mat-cell>
                  </ng-container>

                  <!-- salesPrice Column-->
                  <ng-container matColumnDef="purchaseCommissionPercent">
                    <mat-cell *matCellDef="let element">
                      {{ element?.purchaseCommissionPercent }}
                    </mat-cell>
                  </ng-container>

                  <!-- salesPrice Column-->
                  <ng-container matColumnDef="salesPrice">
                    <mat-cell *matCellDef="let element">
                      {{ element?.salesPrice | number }}
                    </mat-cell>
                  </ng-container>

                  <!-- salesPrice Column-->
                  <ng-container matColumnDef="salesCommissionPercent">
                    <mat-cell *matCellDef="let element" [ngClass]="{'expanded-last-row': !isSmallScreen()}">
                      {{ element?.salesCommissionPercent }}
                    </mat-cell>
                  </ng-container>

                  <!-- Status Column-->
                  <ng-container matColumnDef="status">
                    <mat-cell *matCellDef="let element" [ngClass]="{'expanded-table-sticky end': !isSmallScreen()}">
                      {{ element?.contributionState }}
                    </mat-cell>
                  </ng-container>

                  <!-- Actions Column-->
                  <ng-container matColumnDef="contribution-actions">
                    <mat-cell
                      *matCellDef="let element"
                      [ngClass]="{'expanded-table-sticky end': !isSmallScreen()}"
                    >
                      <mat-icon
                        (click)="navigateToContributionDetail(parentElement, element)"
                        svgIcon="europair_edit"
                        [matTooltip]="'TOOLTIPS.EDIT_CONTRIBUTION'| translate" [matTooltipClass]="'europair-tooltip'">
                      </mat-icon>
                      <mat-icon *ngIf="isContributionSendable(element) "
                        (click)="sendContribution(parentElement, element)"
                        svgIcon="europair_feather_mail"
                        [matTooltip]="'TOOLTIPS.SEND_CONTRIBUTION'| translate" [matTooltipClass]="'europair-tooltip'">
                      </mat-icon>
                      <mat-icon
                        (click)="deleteContribution(parentElement, element)"
                        svgIcon="europair_trash"
                        [matTooltip]="'TOOLTIPS.REMOVE_CONTRIBUTION'| translate" [matTooltipClass]="'europair-tooltip'">
                      </mat-icon>
                    </mat-cell>
                  </ng-container>

                  <mat-row *matRowDef="let element; columns: columnsContributionsToDisplay">
                  </mat-row>
                </mat-table>
              </mat-cell>
            </ng-container>

            <mat-header-row *matHeaderRowDef="columnsContributionsToDisplay; sticky: true"></mat-header-row>
            <mat-row *matRowDef="let element; columns: columnsContributionsToDisplay" class="element-row"
              [class.expanded-row]="expandedContributions.includes(element)" 
              (click)="expandContributionsRow(element)"></mat-row>
            <mat-row class="detail-row" *matRowDef="let element; columns: ['expandedDetail']" [@detailExpand]="
              expandedContributions.includes(element) ? 'expanded' : 'collapsed'
              " style="overflow: hidden"></mat-row>
          </mat-table>
        </div>
      </mat-expansion-panel>

      <mat-expansion-panel #contractsExpansionPanel class="cmd-mb-2" *ngIf="showAction(fileAction.SHOW_CONTRACT)">
        <mat-expansion-panel-header>
          <mat-panel-title>
            {{ "FILES.CONTRACT_TITLE" | translate | sentenceCase }}
          </mat-panel-title>
          <mat-panel-description *ngIf="contractsExpansionPanel.expanded"></mat-panel-description>
        </mat-expansion-panel-header>
        <app-file-contracts [contracts]="contracts" 
          (contractDetail)="navigateToContractDetail($event)"
          (copyContract)="onCopyContract($event)">
        </app-file-contracts>
      </mat-expansion-panel>

      <mat-expansion-panel #additionalServices class="cmd-mb-2" *ngIf="showAction(fileAction.SHOW_ADDITIONAL_SERVICE)">
        <mat-expansion-panel-header>
          <mat-panel-title>
            {{ "FILES.ADDITIONAL_SERVICES.TITLE" | translate | sentenceCase }}
          </mat-panel-title>
          <mat-panel-description *ngIf="additionalServices.expanded && hasRoutes">
            <a mat-button routerLink="additional-services">
              {{ "FILES.ADDITIONAL_SERVICES.NEW" | translate | sentenceCase }}
              <mat-icon svgIcon="europair_add"></mat-icon>
            </a>
          </mat-panel-description>
        </mat-expansion-panel-header>
        <div class="table-container additional-services-table">
          <mat-table matSort multiTemplateDataRows [dataSource]="dataSourceAdditionalService">
            <ng-container matColumnDef="code">
              <mat-header-cell *matHeaderCellDef mat-sort-header>
                {{ "FILES.ADDITIONAL_SERVICES.SERVICE_CODE" | translate}}
              </mat-header-cell>
              <mat-cell *matCellDef="let element">{{ element.code }}</mat-cell>
            </ng-container>
            <ng-container matColumnDef="description">
              <mat-header-cell *matHeaderCellDef mat-sort-header>
                {{ "FILES.ADDITIONAL_SERVICES.DESCRIPTION" | translate}}
              </mat-header-cell>
              <mat-cell *matCellDef="let element">{{ element.description }}</mat-cell>
            </ng-container>
            <ng-container matColumnDef="quantity">
              <mat-header-cell *matHeaderCellDef mat-sort-header>
                {{ "FILES.ADDITIONAL_SERVICES.QUANTITY" | translate}}
              </mat-header-cell>
              <mat-cell *matCellDef="let element">{{ element.quantity }}</mat-cell>
            </ng-container>
            <ng-container matColumnDef="provider">
              <mat-header-cell *matHeaderCellDef mat-sort-header>
                {{ "FILES.ADDITIONAL_SERVICES.PROVIDER" | translate}}
              </mat-header-cell>
              <mat-cell *matCellDef="let element">{{ element.provider?.name }}</mat-cell>
            </ng-container>
            <ng-container matColumnDef="purchasePrice">
              <mat-header-cell *matHeaderCellDef mat-sort-header>
                {{ "FILES.ADDITIONAL_SERVICES.PURCHASE_AMOUNT" | translate}}
              </mat-header-cell>
              <mat-cell *matCellDef="let element">{{ element.purchasePrice }}</mat-cell>
            </ng-container>
            <ng-container matColumnDef="salePrice">
              <mat-header-cell *matHeaderCellDef mat-sort-header>
                {{ "FILES.ADDITIONAL_SERVICES.SALE_AMOUNT" | translate}}
              </mat-header-cell>
              <mat-cell *matCellDef="let element">{{ element.salePrice }}</mat-cell>
            </ng-container>
            <ng-container matColumnDef="tax">
              <mat-header-cell *matHeaderCellDef mat-sort-header>
                {{ "FILES.ADDITIONAL_SERVICES.TAX" | translate}}
              </mat-header-cell>
              <mat-cell *matCellDef="let element">{{ element.tax }}</mat-cell>
            </ng-container>
            <ng-container matColumnDef="commision">
              <mat-header-cell *matHeaderCellDef mat-sort-header>
                {{ "FILES.ADDITIONAL_SERVICES.COMMISSION" | translate}}
              </mat-header-cell>
              <mat-cell *matCellDef="let element">{{ element.commision }}</mat-cell>
            </ng-container>
            <ng-container matColumnDef="comment">
              <mat-header-cell *matHeaderCellDef mat-sort-header>
                {{ "FILES.ADDITIONAL_SERVICES.COMMENT" | translate}}
              </mat-header-cell>
              <mat-cell *matCellDef="let element">{{ element.comment }}</mat-cell>
            </ng-container>
            <ng-container matColumnDef="seller">
              <mat-header-cell *matHeaderCellDef mat-sort-header>
                {{ "FILES.ADDITIONAL_SERVICES.SELLER" | translate}}
              </mat-header-cell>
              <mat-cell *matCellDef="let element">{{ element.seller }}</mat-cell>
            </ng-container>
            <ng-container matColumnDef="status">
              <mat-header-cell *matHeaderCellDef mat-sort-header>
                {{ "FILES.ADDITIONAL_SERVICES.STATUS" | translate}}
              </mat-header-cell>
              <mat-cell *matCellDef="let element">{{ element.status }}</mat-cell>
            </ng-container>
            <!-- Actions Column-->
            <ng-container matColumnDef="actions">
              <mat-header-cell *matHeaderCellDef>
                {{ "FILES.ADDITIONAL_SERVICES.ACTIONS" | translate}}
              </mat-header-cell>
              <mat-cell *matCellDef="let element">
                <mat-icon (click)="runAction($event)" svgIcon="europair_trash"
                [matTooltip]="'TOOLTIPS.REMOVE_ADDITIONAL_SERVICE'| translate" [matTooltipClass]="'europair-tooltip'"></mat-icon>
              </mat-cell>
            </ng-container>
            <mat-header-row *matHeaderRowDef="columnsAdditionalServicesToDisplay"></mat-header-row>
            <mat-row *matRowDef="let element; columns: columnsAdditionalServicesToDisplay" class="element-row">
            </mat-row>
          </mat-table>
        </div>
        <mat-paginator [length]="resultsLength" [pageSize]="pageSize"></mat-paginator>
      </mat-expansion-panel>

      <mat-expansion-panel class="cmd-mb-2">
        <mat-expansion-panel-header>
          <mat-panel-title>
            {{ "FILES.OPERATIONS_OBSERVATIONS.TITLE" | translate | sentenceCase }}
          </mat-panel-title>
        </mat-expansion-panel-header>
        <ng-template matExpansionPanelContent>
          <form [formGroup]="operationForm">
            <div class="row  cmd-mt-1">
              <app-input [prefix]="'FILES.OPERATIONS_OBSERVATIONS.FLIGHT_REASON' | translate" [hasErrors]="hasControlAnyError('flightReason')"
                formControlName="flightMotive" class="col s12 l12">
                <ng-container inputErrors>
                  <ng-container *ngIf="hasControlAnyErrorSpecificForm(operationForm, 'flightMotive')">
                    <span *ngIf="hasControlSpecificErrorSpecificForm(operationForm, 'flightMotive', 'maxlength')" class="helper-text"
                      [attr.data-error]="'FILES.OPERATIONS_OBSERVATIONS.ERROR.MAX_LENGTH' | translate">
                    </span>
                  </ng-container>
                </ng-container>
              </app-input>
            </div>
            <div class="row">
              <app-input [prefix]="'FILES.OPERATIONS_OBSERVATIONS.CONECTIONS' | translate" [hasErrors]="hasControlAnyErrorSpecificForm(operationForm, 'conections')"
                formControlName="connections" class="col s12 l12">
                <ng-container inputErrors>
                  <ng-container *ngIf="hasControlAnyErrorSpecificForm(operationForm, 'connections')">
                    <span *ngIf="hasControlSpecificErrorSpecificForm(operationForm, 'connections', 'maxlength')" class="helper-text"
                      [attr.data-error]="'FILES.OPERATIONS_OBSERVATIONS.ERROR.MAX_LENGTH' | translate">
                    </span>
                  </ng-container>
                </ng-container>
              </app-input>
            </div>
            <div class="row">
              <app-input [prefix]="'FILES.OPERATIONS_OBSERVATIONS.FLIGHT_LIMITATION' | translate" [hasErrors]="hasControlAnyErrorSpecificForm(operationForm, 'flightLimitation')"
                formControlName="limitations" class="col s12 l12">
                <ng-container inputErrors>
                  <ng-container *ngIf="hasControlAnyErrorSpecificForm(operationForm, 'limitations')">
                    <span *ngIf="hasControlSpecificErrorSpecificForm(operationForm, 'limitations', 'maxlength')" class="helper-text"
                      [attr.data-error]="'FILES.OPERATIONS_OBSERVATIONS.ERROR.MAX_LENGTH' | translate">
                    </span>
                  </ng-container>
                </ng-container>
              </app-input>
            </div>
            <div class="row">
              <app-input [prefix]="'FILES.OPERATIONS_OBSERVATIONS.FUEL' | translate" [hasErrors]="hasControlAnyErrorSpecificForm(operationForm, 'fuel')"
                formControlName="fixedVariableFuel" class="col s12 l12">
                <ng-container inputErrors>
                  <ng-container *ngIf="hasControlAnyErrorSpecificForm(operationForm, 'fixedVariableFuel')">
                    <span *ngIf="hasControlSpecificErrorSpecificForm(operationForm, 'fixedVariableFuel', 'maxlength')" class="helper-text"
                      [attr.data-error]="'FILES.OPERATIONS_OBSERVATIONS.ERROR.MAX_LENGTH' | translate">
                    </span>
                  </ng-container>
                </ng-container>
              </app-input>
            </div>
            <div class="row">
              <app-input [prefix]="'FILES.OPERATIONS_OBSERVATIONS.EQUIPMENT' | translate" [hasErrors]="hasControlAnyErrorSpecificForm(operationForm, 'equipment')"
                formControlName="luggage" class="col s12 l12">
                <ng-container inputErrors>
                  <ng-container *ngIf="hasControlAnyErrorSpecificForm(operationForm, 'luggage')">
                    <span *ngIf="hasControlSpecificErrorSpecificForm(operationForm, 'luggage', 'maxlength')" class="helper-text"
                      [attr.data-error]="'FILES.OPERATIONS_OBSERVATIONS.ERROR.MAX_LENGTH' | translate">
                    </span>
                  </ng-container>
                </ng-container>
              </app-input>
            </div>
            <div class="row">
              <app-input [prefix]="'FILES.OPERATIONS_OBSERVATIONS.SPECIAL_EQUIPMENT' | translate" [hasErrors]="hasControlAnyErrorSpecificForm(operationForm, 'especialEquipment')"
                formControlName="specialLuggage" class="col s12 l12">
                <ng-container inputErrors>
                  <ng-container *ngIf="hasControlAnyErrorSpecificForm(operationForm, 'specialLuggage')">
                    <span *ngIf="hasControlSpecificErrorSpecificForm(operationForm, 'specialLuggage', 'maxlength')" class="helper-text"
                      [attr.data-error]="'FILES.OPERATIONS_OBSERVATIONS.ERROR.MAX_LENGTH' | translate">
                    </span>
                  </ng-container>
                </ng-container>
              </app-input>
            </div>
            <div class="row">
              <app-input [prefix]="'FILES.OPERATIONS_OBSERVATIONS.SERVICE_ON_BOARD' | translate" [hasErrors]="hasControlAnyErrorSpecificForm(operationForm, 'serviceOnBoard')"
                formControlName="onBoardService" class="col s12 l12">
                <ng-container inputErrors>
                  <ng-container *ngIf="hasControlAnyErrorSpecificForm(operationForm, 'onBoardService')">
                    <span *ngIf="hasControlSpecificErrorSpecificForm(operationForm, 'onBoardService', 'maxlength')" class="helper-text"
                      [attr.data-error]="'FILES.OPERATIONS_OBSERVATIONS.ERROR.MAX_LENGTH' | translate">
                    </span>
                  </ng-container>
                </ng-container>
              </app-input>
            </div>
            <div class="row">
              <app-input [prefix]="'FILES.OPERATIONS_OBSERVATIONS.SPECIAL_REQUEST' | translate" [hasErrors]="hasControlAnyErrorSpecificForm(operationForm, 'specialRequest')"
                formControlName="specialRequests" class="col s12 l12">
                <ng-container inputErrors>
                  <ng-container *ngIf="hasControlAnyErrorSpecificForm(operationForm, 'specialRequests')">
                    <span *ngIf="hasControlSpecificErrorSpecificForm(operationForm, 'specialRequests', 'maxlength')" class="helper-text"
                      [attr.data-error]="'FILES.OPERATIONS_OBSERVATIONS.ERROR.MAX_LENGTH' | translate">
                    </span>
                  </ng-container>
                </ng-container>
              </app-input>
            </div>
            <div class="row">
              <app-input [prefix]="'FILES.OPERATIONS_OBSERVATIONS.OTHER_CHARGES' | translate" [hasErrors]="hasControlAnyErrorSpecificForm(operationForm, 'otherCharges')"
                formControlName="otherCharges" class="col s12 l12">
                <ng-container inputErrors>
                  <ng-container *ngIf="hasControlAnyErrorSpecificForm(operationForm, 'otherCharges')">
                    <span *ngIf="hasControlSpecificErrorSpecificForm(operationForm, 'otherCharges', 'maxlength')" class="helper-text"
                      [attr.data-error]="'FILES.OPERATIONS_OBSERVATIONS.ERROR.MAX_LENGTH' | translate">
                    </span>
                  </ng-container>
                </ng-container>
              </app-input>
            </div>
            <div class="row">
              <app-input [prefix]="'FILES.OPERATIONS_OBSERVATIONS.OPERATIVE' | translate" [hasErrors]="hasControlAnyErrorSpecificForm(operationForm, 'operative')"
                formControlName="operationalInfo" class="col s12 l12">
                <ng-container inputErrors>
                  <ng-container *ngIf="hasControlAnyErrorSpecificForm(operationForm, 'operationalInfo')">
                    <span *ngIf="hasControlSpecificErrorSpecificForm(operationForm, 'operationalInfo', 'maxlength')" class="helper-text"
                      [attr.data-error]="'FILES.OPERATIONS_OBSERVATIONS.ERROR.MAX_LENGTH' | translate">
                    </span>
                  </ng-container>
                </ng-container>
              </app-input>
            </div>
            <div class="row">
              <mat-form-field class="col s12 l12">
                <mat-label>{{ "FILES.OPERATIONS_OBSERVATIONS.OBSERVATIONS" | translate }}</mat-label>
                <textarea matInput formControlName="observation" [maxlength]="observationMaxLength"></textarea>
              </mat-form-field>
              <button color="primary" class="col s12 l2 offset-l10" (click)="onConfirmOperation()" mat-raised-button [disabled]="operationForm.invalid">
                {{ "FILES.SAVE" | translate }}
              </button>
            </div>
          </form>
        </ng-template>
      </mat-expansion-panel>
    </ng-container>
  </mat-accordion>
</ng-container>
