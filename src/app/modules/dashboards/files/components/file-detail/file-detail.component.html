<ng-container *ngIf="routeData$ | async as routeData">
  <core-page-bar [pageTitle]="routeData.title | translate"></core-page-bar>
  <div class="row">
    <button
      class="browser-default col s12 l2 cmd-mb-2"
      color="primary"
      mat-raised-button
      [disabled]="!fileForm.valid"
      (click)="onSaveFile(routeData.isFileDetail)"
    >
      Guardar Expediente
    </button>

    <button
      *ngIf="showConfirmOperationButton() && routeData.isFileDetail"
      color="primary"
      class="col s12 l2 offset-l8 cmd-mb-1"
      (click)="openConfirmOperationModal()"
      mat-raised-button
    >
      {{ "FILES.CONFIRM_OPERATION" | translate }}
    </button>
  </div>

  <mat-accordion multi>
    <mat-expansion-panel class="app-expansion-panel" expanded="true">
      <mat-expansion-panel-header class="cmd-mb-2">
        <mat-panel-title>
          {{ "COMMON.GENERAL_DATA" | translate | sentenceCase }}
        </mat-panel-title>
      </mat-expansion-panel-header>
      <ng-template matExpansionPanelContent>
        <form [formGroup]="fileForm">
          <div class="row">
            <app-input
              [prefix]="'FILES.CODE' | translate"
              [hasErrors]="hasControlAnyError('code')"
              [errorStateMatcher]="matcher"
              formControlName="code"
              class="col s12 l4"
            >
              <ng-container inputErrors>
                <mat-error
                  class="ep-error-msg"
                  *ngIf="hasControlAnyError('code')"
                >
                  {{ "FILES.ERRORS.CODE" | translate }}
                </mat-error>
              </ng-container>
            </app-input>

            <app-input
              [prefix]="'FILES.DESCRIPTION' | translate"
              [hasErrors]="hasControlAnyError('description')"
              [errorStateMatcher]="matcher"
              formControlName="description"
              class="col s12 l4"
            >
              <ng-container inputErrors>
                <mat-error
                  class="ep-error-msg"
                  *ngIf="hasControlAnyError('description')"
                >
                  {{ "FILES.ERRORS.DESCRIPTION" | translate }}
                </mat-error>
              </ng-container>
            </app-input>

            <app-autocomplete
              class="col s12 l4"
              [options]="statusOptions$ | async"
              [prefix]="'FILES.STATUS' | translate"
              [lengthToTriggerSearch]="0"
              optionValue="id"
              optionLabel="name"
              formControlName="status"
            >
            </app-autocomplete>
          </div>

          <div class="row">
            <!-- <app-input
              [prefix]="'FILES.CLIENT' | translate"
              [hasErrors]="hasControlAnyError('client')"
              [errorStateMatcher]="matcher"
              formControlName="client"
              class="col s12 l4"
            >
              <ng-container inputErrors>
                <mat-error *ngIf="hasControlAnyError('client')">
                  {{ "FILES.ERRORS.CLIENT" | translate }}
                </mat-error>
              </ng-container>
            </app-input> -->

            <app-autocomplete
              class="col s12 l4"
              [options]="clientOptions$ | async"
              [prefix]="'FILES.CLIENT' | translate"
              [lengthToTriggerSearch]="0"
              optionValue="id"
              optionLabel="name"
              formControlName="client"
            >
            </app-autocomplete>
          </div>
        </form>
      </ng-template>
    </mat-expansion-panel>

    <ng-container *ngIf="routeData.isFileDetail">
      <mat-expansion-panel #routes class="app-expansion-panel cmd-mb-2">
        <mat-expansion-panel-header>
          <mat-panel-title>
            {{ "FILES.ROUTES" | translate | sentenceCase }}
          </mat-panel-title>
          <mat-panel-description *ngIf="routes.expanded">
            <a mat-button routerLink="routes/new">
              {{ "FILES.NEW_ROUTE" | translate | sentenceCase }}
              <mat-icon svgIcon="europair_add"></mat-icon>
            </a>
          </mat-panel-description>
        </mat-expansion-panel-header>

        <!-- <ng-template matExpansionPanelContent> -->
        <div class="table-container">
          <mat-table matSort multiTemplateDataRows [dataSource]="dataSource">
            <!-- Label Column -->
            <ng-container matColumnDef="label" sticky>
              <mat-header-cell *matHeaderCellDef mat-sort-header>
                Rutas Petición
              </mat-header-cell>
              <mat-cell *matCellDef="let element" class="parent-route">
                <mat-icon
                  class="expand-icon"
                  *ngIf="element.rotations.length > 0"
                  [class.active]="expandedElements.includes(element)"
                >
                  expand_more
                </mat-icon>
                {{ element.label }}
              </mat-cell>
            </ng-container>

            <!-- Frequency Column -->
            <ng-container matColumnDef="frequency">
              <mat-header-cell *matHeaderCellDef mat-sort-header>
                Frecuencia
              </mat-header-cell>
              <mat-cell *matCellDef="let element">
                {{ element.frequency }}
              </mat-cell>
            </ng-container>

            <!-- startDate Column-->
            <ng-container matColumnDef="startDate">
              <mat-header-cell *matHeaderCellDef mat-sort-header>
                Fecha inicio
              </mat-header-cell>
              <mat-cell *matCellDef="let element">
                {{ element.startDate }}
              </mat-cell>
            </ng-container>

            <!-- EndDate Column-->
            <ng-container matColumnDef="endDate">
              <mat-header-cell *matHeaderCellDef mat-sort-header>
                Fecha Fin
              </mat-header-cell>
              <mat-cell *matCellDef="let element">
                {{ element.endDate }}
              </mat-cell>
            </ng-container>

            <!-- WeekDays Column-->
            <ng-container matColumnDef="frequencyDays">
              <mat-header-cell *matHeaderCellDef mat-sort-header>
                Días semana
              </mat-header-cell>
              <mat-cell *matCellDef="let element">
                {{ getFormattedFrequency(element.frequencyDays) | uppercase }}
              </mat-cell>
            </ng-container>

            <!-- Rotations Column-->
            <ng-container matColumnDef="rotations.length">
              <mat-header-cell *matHeaderCellDef mat-sort-header>
                Rotaciones
              </mat-header-cell>
              <mat-cell *matCellDef="let element">
                {{ element.rotations.length }}
              </mat-cell>
            </ng-container>

            <!-- Seats Column-->
            <ng-container matColumnDef="seats">
              <mat-header-cell *matHeaderCellDef mat-sort-header>
                Asientos F/C/Y
              </mat-header-cell>
              <mat-cell *matCellDef="let element">
                {{ element.seats }}
              </mat-cell>
            </ng-container>

            <!-- PeriodDays Column-->
            <ng-container matColumnDef="periodDays">
              <mat-header-cell *matHeaderCellDef mat-sort-header>
                Días Periodo
              </mat-header-cell>
              <mat-cell *matCellDef="let element">
                {{ element.periodDays }}
              </mat-cell>
            </ng-container>

            <!-- Month Day Column-->
            <ng-container matColumnDef="dayNumber">
              <mat-header-cell *matHeaderCellDef mat-sort-header>
                Día del mes
              </mat-header-cell>
              <mat-cell *matCellDef="let element">
                {{ element.dayNumber }}
              </mat-cell>
            </ng-container>

            <!-- Status Column-->
            <ng-container matColumnDef="status" stickyEnd>
              <mat-header-cell *matHeaderCellDef mat-sort-header>
                Estado
              </mat-header-cell>
              <mat-cell *matCellDef="let element"> Pendiente </mat-cell>
            </ng-container>

            <!-- Actions Column-->
            <ng-container matColumnDef="actions" stickyEnd>
              <mat-header-cell *matHeaderCellDef> Actions </mat-header-cell>
              <mat-cell *matCellDef="let element">
                <!-- <mat-icon
                  (click)="runAction($event)"
                  svgIcon="europair_edit"
                ></mat-icon> -->
                <mat-icon
                  (click)="navigateToSearchAircraft(element.id)"
                  svgIcon="europair_plane"
                ></mat-icon>
                <mat-icon
                  (click)="runAction($event)"
                  svgIcon="europair_trash"
                ></mat-icon>
              </mat-cell>
            </ng-container>

            <!-- Expanded Content Column - The detail row is made up of this one column that spans across all columns -->
            <ng-container matColumnDef="expandedDetail">
              <mat-cell *matCellDef="let parentElement">
                <mat-table [dataSource]="getChildRoutes(parentElement)">
                  <!-- Label Column -->
                  <ng-container matColumnDef="label">
                    <mat-cell
                      *matCellDef="let element"
                      class="expanded-table-sticky start"
                    >
                      <span class="separator"> </span>
                      {{ element.label }}
                    </mat-cell>
                  </ng-container>

                  <!-- Frequency Column -->
                  <ng-container matColumnDef="frequency">
                    <mat-cell *matCellDef="let element">
                      {{ element.frequency }}
                    </mat-cell>
                  </ng-container>

                  <!-- startDate Column-->
                  <ng-container matColumnDef="startDate">
                    <mat-cell *matCellDef="let element">
                      {{ element.startDate }}
                    </mat-cell>
                  </ng-container>

                  <!-- EndDate Column-->
                  <ng-container matColumnDef="endDate">
                    <mat-cell *matCellDef="let element">
                      {{ element.endDate }}
                    </mat-cell>
                  </ng-container>

                  <!-- WeekDays Column-->
                  <ng-container matColumnDef="frequencyDays">
                    <mat-cell *matCellDef="let element">
                      {{
                        getFormattedFrequency(element.frequencyDays) | uppercase
                      }}
                    </mat-cell>
                  </ng-container>

                  <!-- Rotations Column-->
                  <ng-container matColumnDef="rotations.length">
                    <mat-cell *matCellDef="let element">
                      {{ getRotationNumber(parentElement, element) }}
                    </mat-cell>
                  </ng-container>

                  <!-- Seats Column-->
                  <ng-container matColumnDef="seats">
                    <mat-cell *matCellDef="let element">
                      {{ element.seats }}
                    </mat-cell>
                  </ng-container>

                  <!-- PeriodDays Column-->
                  <ng-container matColumnDef="periodDays">
                    <mat-cell *matCellDef="let element">
                      {{ element.periodDays }}
                    </mat-cell>
                  </ng-container>

                  <!-- Month Day Column-->
                  <ng-container matColumnDef="dayNumber">
                    <mat-cell
                      *matCellDef="let element"
                      class="expanded-last-row"
                    >
                      {{ element.dayNumber }}
                    </mat-cell>
                    <mat-cell> - </mat-cell>
                  </ng-container>

                  <!-- Status Column-->
                  <ng-container matColumnDef="status">
                    <mat-cell
                      *matCellDef="let element"
                      class="expanded-table-sticky end"
                    >
                      Pendiente
                    </mat-cell>
                  </ng-container>

                  <!-- Actions Column-->
                  <ng-container matColumnDef="actions">
                    <mat-cell
                      *matCellDef="let element"
                      class="expanded-table-sticky end"
                    >
                      <mat-icon
                        (click)="editRotation(parentElement, element)"
                        svgIcon="europair_edit"
                      ></mat-icon>
                      <mat-icon
                        (click)="navigateToSearchAircraft(element.id)"
                        svgIcon="europair_plane"
                      ></mat-icon>
                      <mat-icon
                        (click)="runAction($event)"
                        svgIcon="europair_trash"
                      ></mat-icon>
                    </mat-cell>
                  </ng-container>

                  <mat-row
                    *matRowDef="let element; columns: columnsToDisplay"
                  ></mat-row>
                </mat-table>
              </mat-cell>
            </ng-container>

            <mat-header-row
              *matHeaderRowDef="columnsToDisplay; sticky: true"
            ></mat-header-row>
            <mat-row
              *matRowDef="let element; columns: columnsToDisplay"
              class="element-row"
              [class.expanded-row]="expandedElements.includes(element)"
              (click)="expandRow(element)"
            ></mat-row>
            <mat-row
              class="detail-row"
              *matRowDef="let element; columns: ['expandedDetail']"
              [@detailExpand]="
                expandedElements.includes(element) ? 'expanded' : 'collapsed'
              "
              style="overflow: hidden"
            ></mat-row>
          </mat-table>
        </div>

        <mat-paginator
          [length]="resultsLength"
          [pageSize]="pageSize"
        ></mat-paginator>
      </mat-expansion-panel>

      <mat-expansion-panel #additionalServices class="cmd-mb-2">
        <mat-expansion-panel-header>
          <mat-panel-title>
            {{ "FILES.ADDITIONAL_SERVICES.TITLE" | translate | sentenceCase }}
          </mat-panel-title>
          <mat-panel-description *ngIf="additionalServices.expanded && hasRoutes">
            <a mat-button routerLink="additional-services">
              {{ "FILES.ADDITIONAL_SERVICES.NEW" | translate | sentenceCase }}
              <mat-icon svgIcon="europair_add"></mat-icon>
            </a>
          </mat-panel-description>
        </mat-expansion-panel-header>
        <div class="table-container additional-services-table">
          <mat-table matSort multiTemplateDataRows [dataSource]="dataSourceAdditionalService">
            <ng-container matColumnDef="code">
              <mat-header-cell *matHeaderCellDef mat-sort-header>
                {{ "FILES.ADDITIONAL_SERVICES.SERVICE_CODE" | translate}}
              </mat-header-cell>
              <mat-cell *matCellDef="let element">{{ element.code }}</mat-cell>
            </ng-container>
            <ng-container matColumnDef="description">
              <mat-header-cell *matHeaderCellDef mat-sort-header>
                {{ "FILES.ADDITIONAL_SERVICES.DESCRIPTION" | translate}}
              </mat-header-cell>
              <mat-cell *matCellDef="let element">{{ element.description }}</mat-cell>
            </ng-container>
            <ng-container matColumnDef="quantity">
              <mat-header-cell *matHeaderCellDef mat-sort-header>
                {{ "FILES.ADDITIONAL_SERVICES.QUANTITY" | translate}}
              </mat-header-cell>
              <mat-cell *matCellDef="let element">{{ element.quantity }}</mat-cell>
            </ng-container>
            <ng-container matColumnDef="provider">
              <mat-header-cell *matHeaderCellDef mat-sort-header>
                {{ "FILES.ADDITIONAL_SERVICES.PROVIDER" | translate}}
              </mat-header-cell>
              <mat-cell *matCellDef="let element">{{ element.provider?.name }}</mat-cell>
            </ng-container>
            <ng-container matColumnDef="purchasePrice">
              <mat-header-cell *matHeaderCellDef mat-sort-header>
                {{ "FILES.ADDITIONAL_SERVICES.PURCHASE_AMOUNT" | translate}}
              </mat-header-cell>
              <mat-cell *matCellDef="let element">{{ element.purchasePrice }}</mat-cell>
            </ng-container>
            <ng-container matColumnDef="salePrice">
              <mat-header-cell *matHeaderCellDef mat-sort-header>
                {{ "FILES.ADDITIONAL_SERVICES.SALE_AMOUNT" | translate}}
              </mat-header-cell>
              <mat-cell *matCellDef="let element">{{ element.salePrice }}</mat-cell>
            </ng-container>
            <ng-container matColumnDef="tax">
              <mat-header-cell *matHeaderCellDef mat-sort-header>
                {{ "FILES.ADDITIONAL_SERVICES.TAX" | translate}}
              </mat-header-cell>
              <mat-cell *matCellDef="let element">{{ element.tax }}</mat-cell>
            </ng-container>
            <ng-container matColumnDef="commision">
              <mat-header-cell *matHeaderCellDef mat-sort-header>
                {{ "FILES.ADDITIONAL_SERVICES.COMMISSION" | translate}}
              </mat-header-cell>
              <mat-cell *matCellDef="let element">{{ element.commision }}</mat-cell>
            </ng-container>
            <ng-container matColumnDef="comment">
              <mat-header-cell *matHeaderCellDef mat-sort-header>
                {{ "FILES.ADDITIONAL_SERVICES.COMMENT" | translate}}
              </mat-header-cell>
              <mat-cell *matCellDef="let element">{{ element.comment }}</mat-cell>
            </ng-container>
            <ng-container matColumnDef="seller">
              <mat-header-cell *matHeaderCellDef mat-sort-header>
                {{ "FILES.ADDITIONAL_SERVICES.SELLER" | translate}}
              </mat-header-cell>
              <mat-cell *matCellDef="let element">{{ element.seller }}</mat-cell>
            </ng-container>
            <ng-container matColumnDef="status">
              <mat-header-cell *matHeaderCellDef mat-sort-header>
                {{ "FILES.ADDITIONAL_SERVICES.STATUS" | translate}}
              </mat-header-cell>
              <mat-cell *matCellDef="let element">{{ element.status }}</mat-cell>
            </ng-container>
            <!-- Actions Column-->
            <ng-container matColumnDef="actions">
              <mat-header-cell *matHeaderCellDef>
                {{ "FILES.ADDITIONAL_SERVICES.ACTIONS" | translate}}
              </mat-header-cell>
              <mat-cell *matCellDef="let element">
                <mat-icon (click)="runAction($event)" svgIcon="europair_trash"></mat-icon>
              </mat-cell>
            </ng-container>
            <mat-header-row *matHeaderRowDef="columnsAdditionalServicesToDisplay"></mat-header-row>
            <mat-row *matRowDef="let element; columns: columnsAdditionalServicesToDisplay" class="element-row"></mat-row>
          </mat-table>
        </div>
        <mat-paginator [length]="resultsLength" [pageSize]="pageSize"></mat-paginator>
      </mat-expansion-panel>

      <mat-expansion-panel class="cmd-mb-2">
        <mat-expansion-panel-header>
          <mat-panel-title>
            {{ "Cotizaciones" | translate | sentenceCase }}
          </mat-panel-title>
        </mat-expansion-panel-header>
        <ng-template matExpansionPanelContent> </ng-template>
      </mat-expansion-panel>

      <mat-expansion-panel class="cmd-mb-2">
        <mat-expansion-panel-header>
          <mat-panel-title>
            {{ "FILES.OBSERVATIONS" | translate | sentenceCase }}
          </mat-panel-title>
        </mat-expansion-panel-header>
        <ng-template matExpansionPanelContent>
          <div class="row">
            <mat-form-field class="col s12 l12 cmd-mt-1">
              <mat-label>{{
                "FILES.OBSERVATIONS_LABEL" | translate
              }}</mat-label>
              <textarea
                matInput
                [(ngModel)]="observations"
                [maxlength]="observationMaxLength"
              ></textarea>
            </mat-form-field>
            <button
              color="primary"
              class="col s12 l2 offset-l10"
              (click)="saveObservation()"
              mat-raised-button
            >
              {{ "FILES.CONFIRM" | translate }}
            </button>
          </div>
        </ng-template>
      </mat-expansion-panel>
    </ng-container>
  </mat-accordion>
</ng-container>

<core-modal>
  <ng-container content>
    <section class="modal-header">
      <h4>{{ "FILES.CONFIRM_OPERATION" | translate }}</h4>
      <a class="waves-effect btn-flat modal-close europair-button-blue-1">
        <i class="material-icons right">close</i>
        {{ "FILES.CANCEL" | translate }}
      </a>
    </section>
    <section class="modal-body">
      <div class="row">
        <p>{{ "FILES.MSG_OPERATION" | translate }}</p>
        <mat-form-field class="col s12 l12 cmd-mt-1">
          <mat-label>{{ "FILES.OBSERVATIONS_LABEL" | translate }}</mat-label>
          <textarea
            matInput
            [(ngModel)]="observations"
            [maxlength]="observationMaxLength"
          ></textarea>
        </mat-form-field>
      </div>
    </section>
  </ng-container>
  <ng-container footer>
    <a
      class="btn modal-close waves-effect europair-icon-blue-1 cmd-w-100"
      (click)="onConfirmOperation()"
    >
      <i class="material-icons">check_circle</i>
      <span class="full-width-btn-text">{{ "FILES.CONFIRM" | translate }}</span>
    </a>
  </ng-container>
</core-modal>
